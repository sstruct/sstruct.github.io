<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> [译]用 Mongoose 轻松开发 Node.js + MongoDB 应用 · yangtze 的独立博客</title><meta name="description" content="[译]用 Mongoose 轻松开发 Node.js + MongoDB 应用 - yangtze"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/5511562391" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/sstruct" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">[译]用 Mongoose 轻松开发 Node.js + MongoDB 应用</h1><div class="post-time">May 15, 2016</div><div class="post-content"><blockquote>
<p> 写一个Node项目需要用到<code>MongoDB</code>,<code>Express</code>和<code>Node</code>,于是翻译了这篇博客. 介绍了MongoDB和mongoose的搭配使用,和在Node环境中管理数据库的过程.</p>
<p>原文请见 <a href="https://scotch.io/tutorials/using-mongoosejs-in-node-js-and-mongodb-applications" target="_blank" rel="external">Easily Develop Node.js and MongoDB Apps with Mongoose</a></p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Node.js 和 MongoDB 是天造地设的一对. MongoDB 跨越数据库和 Javascript，随意使用 JSON 的特性，使得开发过程变得非常容易. 这也是为什么会有 MEAN 这样的架构出现的原因，MEAN 架构正是指采用了 Node, Express, MongoDB, AngularJS 的技术栈.</p>
<a id="more"></a>
<p>CRUD 是目前大多数应用开发所必要的部分，我们随时都需要需要创建，读取，更新，删除数据.</p>
<p>下面我们将通过一些代码片段了解一下在 Node.js, ExpressJS 和 MongoDB 中该如何处理 CRUD. 我们还将使用到一个常用的 Node 库: <a href="http://mongoosejs.com/" target="_blank" rel="external">mongoose</a></p>
<p>我们使用 CRUD 函数写出的 API， 常常也被称为 Node.js RESTful API. 读完这篇文章，你将了解实际代码长什么样. 这篇文章介绍了 mongoose 的多种命令和它们的用法.</p>
<h2 id="什么是-Mongoose"><a href="#什么是-Mongoose" class="headerlink" title="什么是 Mongoose?"></a>什么是 Mongoose?</h2><p>mongoose 是一个 Node 中的对象建模工具，跟其它语言中的 ORM 类似（比如 Eloquent for Laravel）.</p>
<p>mongoose 让我们能简单方便的连接到 MongoDB 进行 CRUD 操作. 首先我们要安装好 mongoose，然后才能开始使用.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install mongoose --save</span><br></pre></td></tr></table></figure>
<p>已经安装好 mongoose，我们再在自己的项目中引入它.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br></pre></td></tr></table></figure>
<p>我们还需要连接到 MongoDB 数据库（不管是本地的还是远程的）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/myappdatabase'</span>);</span><br></pre></td></tr></table></figure>
<p>下面我们开始正式使用.</p>
<h2 id="模型的定义（Model）"><a href="#模型的定义（Model）" class="headerlink" title="模型的定义（Model）"></a>模型的定义（<code>Model</code>）</h2><p>在我们处理 CRUD 操作之前，需要建立好 mongoose 模型（<a href="http://mongoosejs.com/docs/models.html" target="_blank" rel="external">mongoose Model</a>）. 这些模型将作为我们定义的数据结构的构造函数. 它们表示了可以从数据库保存和检索的<code>文档</code>（document）的结构.</p>
<p><strong>Mongoose Schema</strong> <a href="http://mongoosejs.com/docs/guide.html" target="_blank" rel="external">mongoose schema</a> 定义了文档属性，主要是键和键值的类型.</p>
<p><strong>Mongoose Methods</strong> （除了自带的方法），自定义方法也可以被定义到 mongoose schema 中.</p>
<h2 id="例子：Users-模型"><a href="#例子：Users-模型" class="headerlink" title="例子：Users 模型"></a>例子：Users 模型</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入要用到的JS模块</span></span><br><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> Schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 schema</span></span><br><span class="line"><span class="keyword">var</span> userSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  username: &#123; type: <span class="built_in">String</span>, required: <span class="literal">true</span>, unique: <span class="literal">true</span> &#125;,</span><br><span class="line">  password: &#123; type: <span class="built_in">String</span>, required: <span class="literal">true</span> &#125;,</span><br><span class="line">  admin: <span class="built_in">Boolean</span>,</span><br><span class="line">  location: <span class="built_in">String</span>,</span><br><span class="line">  meta: &#123;</span><br><span class="line">    age: <span class="built_in">Number</span>,</span><br><span class="line">    website: <span class="built_in">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  created_at: <span class="built_in">Date</span>,</span><br><span class="line">  updated_at: <span class="built_in">Date</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在的 schema 还是没什么用的</span></span><br><span class="line"><span class="comment">// 我们还需要在它的基础上创建一个模型 (model)</span></span><br><span class="line"><span class="keyword">var</span> User = mongoose.model(<span class="string">'User'</span>, userSchema);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出我们之前定义好的 user model</span></span><br><span class="line"><span class="built_in">module</span>.exports = User;</span><br></pre></td></tr></table></figure>
<p>这就是创建 Schema 的方式. 首先要引入 mongoose 和 mongoose.schema 库. 然后在 userSchema 中定义 user 数据的属性. 另外要提的一点是我们可以定义嵌套的数据结构，就像例子中的<code>meta</code>属性那样.</p>
<p>mongodb 支持的数据类型（SchemaTypes）有：</p>
<ul>
<li>String</li>
<li>Number</li>
<li>Date</li>
<li>Buffer</li>
<li>Boolean</li>
<li>Mixed</li>
<li>ObjectId</li>
<li>Array</li>
</ul>
<p>然后我们调用 <code>mongoose.model</code> 创建一个 mongoose 模型. 同样，我们还可以定义很多其它的方法，比如定义一个密码加密算法等等.</p>
<h2 id="自定义方法"><a href="#自定义方法" class="headerlink" title="自定义方法"></a>自定义方法</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注释和上段代码重复的部分省略</span></span><br><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> Schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此处省略号省略部分和上一段代码中这部分相同</span></span><br><span class="line"><span class="keyword">var</span> userSchema ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义一个方法，该方法在用户名后面加上一个字符串</span></span><br><span class="line"><span class="comment">// 你还可以定义很多重要的方法，比如用户名安全检测或者是格式化</span></span><br><span class="line"><span class="comment">// 你还可以进行查询，查询类似用户等等</span></span><br><span class="line">userSchema.methods.dudify = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = <span class="keyword">this</span>.name + <span class="string">'-dude'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> User = mongoose.model(<span class="string">'User'</span>, userSchema);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = User;</span><br></pre></td></tr></table></figure>
<h2 id="使用实例"><a href="#使用实例" class="headerlink" title="使用实例"></a>使用实例</h2><p>现在我们有了自定义模型和方法，我们可以在自己的代码中调用它们.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设 user.js 文件位于 app/models/ 目录下</span></span><br><span class="line"><span class="keyword">var</span> User = <span class="built_in">require</span>(<span class="string">'./app/models/user'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个新用户，名字是 chris</span></span><br><span class="line"><span class="keyword">var</span> chris = <span class="keyword">new</span> User(&#123;</span><br><span class="line">  name: <span class="string">'Chris'</span>,</span><br><span class="line">  username: <span class="string">'sevilayha'</span>,</span><br><span class="line">  password: <span class="string">'password'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用自定义方法. 在原名后面加上 '-dude'</span></span><br><span class="line"><span class="comment">// 最终用户名会是 Chris-dude</span></span><br><span class="line">chris.dudify(<span class="function"><span class="keyword">function</span>(<span class="params">err, name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Your new name is '</span> + name);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 mongoose 自带的 save 方法，将数据保存到数据库</span></span><br><span class="line">chris.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'User saved successfully!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这个例子虽然没有任何实用性，但是创建和使用自定义方法的方式却是通用的. 用类似的步骤，我们可以在保存之前对用户密码使用 hash 方法处理，对比密码等等.</p>
<h2 id="在保存之前运行一个函数"><a href="#在保存之前运行一个函数" class="headerlink" title="在保存之前运行一个函数"></a>在保存之前运行一个函数</h2><p>假如我们还需要保存数据创建的时间 <code>created_at</code>，我们可以添加一个 <code>pre</code> 方法，用它把将要保存的数据进行一些预先处理.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在每次保存之前，添加一个 date 属性</span></span><br><span class="line">userSchema.pre(<span class="string">'save'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 获取当前时间</span></span><br><span class="line">  <span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把 updated_at 更新到当前时间</span></span><br><span class="line">  <span class="keyword">this</span>.updated_at = currentDate;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果 created_at 不存在，同样把它添加进去</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.created_at)</span><br><span class="line">    <span class="keyword">this</span>.created_at = currentDate;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>现在每次保存时，date 都会得到更新. 对密码进行 hash 或者 salt 处理跟这个类似，永远也别保存明文密码.</p>
<p>我们还可以在 model 和 schema 上定义很多东西，如 statics 和 indexes. 详情请看<a href="http://mongoosejs.com/docs/guide.html" target="_blank" rel="external">官方文档</a></p>
<h2 id="Create-–-创建"><a href="#Create-–-创建" class="headerlink" title="Create – 创建"></a>Create – 创建</h2><p>我们将使用之前定义的 <code>User</code> 方法. mongoose Models 原生的 <code>save</code> 方法是专门用来向数据库存入真实数据的.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> User = <span class="built_in">require</span>(<span class="string">'./app/models/user'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个新的用户 newUser</span></span><br><span class="line"><span class="keyword">var</span> newUser = User(&#123;</span><br><span class="line">  name: <span class="string">'Peter Quill'</span>,</span><br><span class="line">  username: <span class="string">'starlord55'</span>,</span><br><span class="line">  password: <span class="string">'password'</span>,</span><br><span class="line">  admin: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存 newUser</span></span><br><span class="line">newUser.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'User created!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Read-–-读取"><a href="#Read-–-读取" class="headerlink" title="Read – 读取"></a>Read – 读取</h2><p>我们多数情况下都是在查询数据，比如某个用户，或者全部用户，或者某类用户等等不同类别. 下面是几个例子：</p>
<h3 id="FIND-ALL"><a href="#FIND-ALL" class="headerlink" title="FIND ALL"></a>FIND ALL</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询所有用户</span></span><br><span class="line">User.find(&#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, users</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// object of the user</span></span><br><span class="line">  <span class="built_in">console</span>.log(users);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="FIND-ONE"><a href="#FIND-ONE" class="headerlink" title="FIND ONE"></a>FIND ONE</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询用户 starlord55</span></span><br><span class="line">User.find(&#123; username: <span class="string">'starlord55'</span> &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// object of the user</span></span><br><span class="line">  <span class="built_in">console</span>.log(user);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="FIND-BY-ID"><a href="#FIND-BY-ID" class="headerlink" title="FIND BY ID"></a>FIND BY ID</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据 ID 查询</span></span><br><span class="line">User.findById(<span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// show the one user</span></span><br><span class="line">  <span class="built_in">console</span>.log(user);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="QUERYING"><a href="#QUERYING" class="headerlink" title="QUERYING"></a>QUERYING</h3><p>我们也可以直接使用 MongoDB 的原生语句进行查询</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询近一个月创建的用户数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿到距现在一个月前的时间点</span></span><br><span class="line"><span class="keyword">var</span> monthAgo = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">monthAgo.setMonth(monthAgo.getMonth() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">User.find(&#123; admin: <span class="literal">true</span> &#125;).where(<span class="string">'created_at'</span>).gt(monthAgo).exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, users</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// show the admins in the past month</span></span><br><span class="line">  <span class="built_in">console</span>.log(users);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Update-–-更新"><a href="#Update-–-更新" class="headerlink" title="Update – 更新"></a>Update – 更新</h2><p>这里我们先查询某个特定的用户，然后更改一部分属性值，并再次存入更新后的数据.</p>
<h3 id="查询，然后更新"><a href="#查询，然后更新" class="headerlink" title="查询，然后更新"></a>查询，然后更新</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询到 ID 为 1 的用户</span></span><br><span class="line">User.findById(<span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更改该用户的地址信息</span></span><br><span class="line">  user.location = <span class="string">'uk'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存用户信息</span></span><br><span class="line">  user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'User successfully updated!'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>记得我们前面创建的 updated_at 函数吗，当保存更改的时候也会触发这个函数.</p>
<h3 id="查询并更新"><a href="#查询并更新" class="headerlink" title="查询并更新"></a>查询并更新</h3><p>另一个更简便的方法是直接使用 mongodb 的 <code>findAndModify</code> 命令</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找到用户 starlord55</span></span><br><span class="line"><span class="comment">// 更新数据为 starlord88</span></span><br><span class="line">User.findOneAndUpdate(&#123; username: <span class="string">'starlord55'</span> &#125;, &#123; username: <span class="string">'starlord88'</span> &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新后的用户会返回给我们</span></span><br><span class="line">  <span class="built_in">console</span>.log(user);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="根据-ID-查询并更新"><a href="#根据-ID-查询并更新" class="headerlink" title="根据 ID 查询并更新"></a>根据 ID 查询并更新</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询用户 id 为 4</span></span><br><span class="line"><span class="comment">// 更新用户名为 starlord88</span></span><br><span class="line">User.findByIdAndUpdate(<span class="number">4</span>, &#123; username: <span class="string">'starlord88'</span> &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回新的数据</span></span><br><span class="line">  <span class="built_in">console</span>.log(user);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="Delete-–-删除"><a href="#Delete-–-删除" class="headerlink" title="Delete – 删除"></a>Delete – 删除</h2><h3 id="查询到用户，然后删除"><a href="#查询到用户，然后删除" class="headerlink" title="查询到用户，然后删除"></a>查询到用户，然后删除</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询到用户 starlord55</span></span><br><span class="line">User.find(&#123; username: <span class="string">'starlord55'</span> &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, user</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除</span></span><br><span class="line">  user.remove(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'User successfully deleted!'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="查询并删除-–-更方便的方法"><a href="#查询并删除-–-更方便的方法" class="headerlink" title="查询并删除 – 更方便的方法"></a>查询并删除 – 更方便的方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 查询 id 为 4 的用户</span><br><span class="line">User.findOneAndRemove(&#123; username: &apos;starlord55&apos; &#125;, function(err) &#123;</span><br><span class="line">  if (err) throw err;</span><br><span class="line"></span><br><span class="line">  // 已经删除了</span><br><span class="line">  console.log(&apos;User deleted!&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="根据-ID-查询并删除"><a href="#根据-ID-查询并删除" class="headerlink" title="根据 ID 查询并删除"></a>根据 ID 查询并删除</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询 id 为 4 的用户</span></span><br><span class="line">User.findByIdAndRemove(<span class="number">4</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 已经删除了</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'User deleted!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>希望这篇文章能成为您在使用 mongoose, Node.js 和 MongoDB 中的一篇好参考.</p>
<p>原文：<a href="https://scotch.io/tutorials/using-mongoosejs-in-node-js-and-mongodb-applications" target="_blank" rel="external">Easily Develop Node.js and MongoDB Apps with Mongoose</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/04/17/JS-常用函数和简单算法（二）/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 <a href="http://sstruct.github.io">yangtze</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-76054950-1",'auto');ga('send','pageview');</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>